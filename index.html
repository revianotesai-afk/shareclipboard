<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Text & File (Base64)</title>
    <style>
        /* Default Theme: DARK MODE */
        :root {
            --primary: #3B82F6;
            --primary-hover: #2563EB;
            --bg: #111827;
            --card: #1F2937;
            --text: #F9FAFB;
            --border: #374151;
            --header-text: #FFFFFF;
        }

        /* LIGHT MODE */
        [data-theme="light"] {
            --primary: #2563EB;
            --primary-hover: #1D4ED8;
            --bg: #F3F4F6;
            --card: #FFFFFF;
            --text: #1F2937;
            --border: #E5E7EB;
            --header-text: #FFFFFF;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        header {
            background-color: var(--primary);
            color: var(--header-text);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .header-btns {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .container {
            padding: 16px;
            max-width: 600px;
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card {
            background-color: var(--card);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        h3 { margin: 0 0 12px 0; font-size: 1.1rem; }
        
        textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            background-color: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            resize: none;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 12px;
        }

        input[type="file"] {
            margin-bottom: 12px;
            color: var(--text);
            width: 100%;
        }

        .btn-full {
            width: 100%;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn-full:active { background-color: var(--primary-hover); }
        .btn-full:disabled { background-color: #6B7280; cursor: not-allowed; }

        .target-badge {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        #mediaContainer img, #mediaContainer video {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        /* Drawer Styling */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            opacity: 0; visibility: hidden; transition: 0.3s; z-index: 40;
        }
        .overlay.active { opacity: 1; visibility: visible; }

        .drawer {
            position: fixed; top: 0; right: -280px;
            width: 280px; height: 100%;
            background: var(--card);
            box-shadow: -4px 0 15px rgba(0,0,0,0.5);
            transition: 0.3s ease-in-out; z-index: 50;
            display: flex; flex-direction: column;
        }
        .drawer.active { right: 0; }
        .drawer-header {
            padding: 16px; background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text);}
        .user-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .user-item {
            padding: 16px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .user-item:hover { background-color: var(--bg); }
        .status-dot { width: 10px; height: 10px; background-color: #10B981; border-radius: 50%; }

        /* Toast Notification (Green Text) */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10B981;
            color: #ffffff;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: 0.3s ease;
            z-index: 100;
            text-align: center;
        }
        .toast.show { opacity: 1; visibility: visible; top: 80px; }

    </style>
</head>
<body data-theme="dark">

    <div id="connectionToast" class="toast"></div>

    <header>
        <div>
            <strong style="font-size: 1.2rem;">ShareIt (Zero-Setup)</strong><br>
            <span style="font-size: 0.8rem;" id="myIdentity">Menghubungkan...</span>
        </div>
        <div class="header-btns">
            <button class="icon-btn" onclick="toggleTheme()">ðŸŒ—</button>
            <button class="icon-btn" onclick="toggleDrawer(true)">ðŸ‘¥ Users</button>
        </div>
    </header>

    <div class="container">
        
        <div class="card">
            <h3>Kirim Data</h3>
            <div id="targetIndicator" class="target-badge" style="display: none;">Target: <span id="targetNameLabel"></span></div>
            
            <textarea id="textToSend" placeholder="Ketik pesan teks di sini..."></textarea>
            <label style="font-size: 0.9rem; margin-bottom: 4px; display: block;">Sertakan File (< 3MB):</label>
            <input type="file" id="fileInput" accept="image/*, video/*">
            
            <button id="sendBtn" class="btn-full" onclick="sendData()" disabled>
                Kirim
            </button>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin:0;">Kotak Masuk</h3>
                <span style="font-size: 0.8rem; color: #9CA3AF;" id="senderInfoLabel">Kosong</span>
            </div>
            <div id="mediaContainer"></div>
            <textarea id="receivedText" readonly placeholder="Teks masuk..."></textarea>
            <button class="btn-full" onclick="copyText()" style="background-color: #10B981;">
                ðŸ“‹ Copy Teks
            </button>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleDrawer(false)"></div>
    <div class="drawer" id="drawer">
        <div class="drawer-header">
            <strong>Pilih Penerima</strong>
            <button class="close-btn" onclick="toggleDrawer(false)">âœ–</button>
        </div>
        <ul class="user-list" id="userList">
            <li style="padding: 16px; text-align: center;">Mencari pengguna...</li>
        </ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        // KITA HAPUS STORAGE: Tidak perlu import Firebase Storage lagi!

        const firebaseConfig = {
            apiKey: "AIzaSyCuEQQU_K8VFMrK7iu0tCvB3ujb_d75w-Y",
            databaseURL: "https://missionimposibble-4e6a1-default-rtdb.firebaseio.com",
            projectId: "missionimposibble-4e6a1",
            storageBucket: "missionimposibble-4e6a1.firebasestorage.app",
            appId: "1:139983716532:android:478a8c5c61b81cf1a2d7e1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let myUid = null;
        let myName = 'User_' + Math.floor(Math.random() * 9000 + 1000);
        let selectedTargetUid = null;

        // Theme Manager
        if (localStorage.getItem('theme') === 'light') {
            document.body.setAttribute('data-theme', 'light');
        }

        window.toggleTheme = function() {
            const body = document.body;
            if (body.getAttribute('data-theme') === 'light') {
                body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        };

        signInAnonymously(auth).catch((error) => console.error("Auth Error:", error));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = user.uid;
                document.getElementById('myIdentity').innerText = myName + ' (Online)';
                setupPresence();
                listenForIncomingData();
                listenForConnections();
            }
        });

        function setupPresence() {
            const connectedRef = ref(db, '.info/connected');
            const myUserRef = ref(db, `users/${myUid}`);

            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    onDisconnect(myUserRef).remove().then(() => {
                        set(myUserRef, { uid: myUid, name: myName });
                    });
                }
            });

            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                const userListEl = document.getElementById('userList');
                userListEl.innerHTML = '';
                let count = 0;
                if (snapshot.exists()) {
                    snapshot.forEach((childSnap) => {
                        const userData = childSnap.val();
                        if (userData.uid !== myUid) {
                            count++;
                            const li = document.createElement('li');
                            li.className = 'user-item';
                            li.onclick = () => window.selectTarget(userData.uid, userData.name);
                            li.innerHTML = `<span>${userData.name}</span><span class="status-dot"></span>`;
                            userListEl.appendChild(li);
                        }
                    });
                }
                if (count === 0) userListEl.innerHTML = '<li style="padding: 16px; text-align: center;">Tidak ada user lain.</li>';
            });
        }

        // Listener Notifikasi "Anda terconnect oleh..."
        function listenForConnections() {
            const connectionRef = ref(db, `connections/${myUid}`);
            onValue(connectionRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    showToast(`Anda terconnect oleh ${data.fromName}`);
                    remove(connectionRef);
                }
            });
        }

        function showToast(message) {
            const toast = document.getElementById('connectionToast');
            toast.innerText = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        }

        function listenForIncomingData() {
            const myInboxRef = ref(db, `shared_texts/${myUid}`);
            onValue(myInboxRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    document.getElementById('receivedText').value = data.text || '';
                    document.getElementById('senderInfoLabel').innerText = `Dari: ${data.fromName}`;
                    
                    const mediaContainer = document.getElementById('mediaContainer');
                    mediaContainer.innerHTML = ''; 
                    
                    // Menampilkan dari Base64 URL
                    if (data.fileBase64) {
                        if (data.fileType === 'image') {
                            mediaContainer.innerHTML = `<img src="${data.fileBase64}" alt="Received Image">`;
                        } else if (data.fileType === 'video') {
                            mediaContainer.innerHTML = `<video src="${data.fileBase64}" controls></video>`;
                        }
                    }
                    
                    if (navigator.vibrate) navigator.vibrate(200);
                    remove(myInboxRef);
                }
            });
        }

        window.toggleDrawer = function(show) {
            const drawer = document.getElementById('drawer');
            const overlay = document.getElementById('overlay');
            if(show) {
                drawer.classList.add('active'); overlay.classList.add('active');
            } else {
                drawer.classList.remove('active'); overlay.classList.remove('active');
            }
        };

        window.selectTarget = function(uid, name) {
            selectedTargetUid = uid;
            document.getElementById('targetIndicator').style.display = 'inline-block';
            document.getElementById('targetNameLabel').innerText = name;
            document.getElementById('sendBtn').disabled = false;
            window.toggleDrawer(false);

            // Trigger notifikasi hijau di layar target
            const targetConnRef = ref(db, `connections/${uid}`);
            set(targetConnRef, { fromName: myName, timestamp: Date.now() });
        };

        // ENGINEER TRICK: Convert file ke string Base64 menggunakan API bawaan browser
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        window.sendData = async function() {
            if (!selectedTargetUid) return;
            
            const textContent = document.getElementById('textToSend').value;
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!textContent.trim() && !file) {
                alert("Isi teks atau pilih file terlebih dahulu!");
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.innerHTML = 'Memproses...';
            sendBtn.disabled = true;

            let fileBase64 = null;
            let fileType = null;

            if (file) {
                // LIMITASI 3MB: Mencegah Realtime DB jebol atau browser freeze
                const maxSize = 3 * 1024 * 1024;
                if (file.size > maxSize) {
                    alert("Ukuran file terlalu besar untuk metode Base64! Maksimal 3MB.");
                    resetBtn();
                    return;
                }

                const isImage = file.type.startsWith('image/');
                const isVideo = file.type.startsWith('video/');
                
                if (!isImage && !isVideo) {
                    alert("Format tidak didukung. Pilih Gambar/Video.");
                    resetBtn();
                    return;
                }

                fileType = isImage ? 'image' : 'video';
                try {
                    sendBtn.innerHTML = 'Encoding File...';
                    fileBase64 = await getBase64(file);
                } catch (error) {
                    alert("Gagal membaca file: " + error.message);
                    resetBtn();
                    return;
                }
            }

            // Kirim teks dan string Base64 ke RTDB target
            sendBtn.innerHTML = 'Mengirim Pesan...';
            const targetInboxRef = ref(db, `shared_texts/${selectedTargetUid}`);
            
            set(targetInboxRef, {
                text: textContent,
                fileBase64: fileBase64, // Simpan string Base64 langsung
                fileType: fileType,
                fromName: myName,
                timestamp: Date.now()
            }).then(() => {
                showToast("Berhasil terkirim!");
                document.getElementById('textToSend').value = '';
                document.getElementById('fileInput').value = '';
            }).catch((error) => {
                alert("Gagal mengirim: Data mungkin terlalu besar (" + error.message + ")");
            }).finally(() => {
                resetBtn();
            });
        };

        function resetBtn() {
            const btn = document.getElementById('sendBtn');
            btn.innerHTML = 'Kirim';
            btn.disabled = false;
        }

        window.copyText = function() {
            const copyInput = document.getElementById("receivedText");
            if (!copyInput.value) return alert("Belum ada teks!");
            copyInput.select();
            copyInput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyInput.value).then(() => showToast("Teks disalin!"));
        };
    </script>
</body>
</html>
